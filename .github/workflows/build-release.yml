name: Build and Release MedImager

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: true
        type: boolean

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v3

    - name: Install dependencies
      run: uv sync --dev

    - name: Build application
      run: uv run pyinstaller MedImager.spec --clean --noconfirm

    - name: Get project info
      id: project_info
      run: |
        $content = Get-Content "pyproject.toml" -Raw
        $version = ($content | Select-String 'version = "([^"]+)"').Matches[0].Groups[1].Value
        echo "version=$version" >> $env:GITHUB_OUTPUT

    - name: Create release package
      run: |
        $version = "${{ steps.project_info.outputs.version }}"
        $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
        $prerelease = "${{ github.event.inputs.prerelease || true }}"

        if ($prerelease -eq 'true') {
          $releaseDir = "MedImager_v${version}_preview_${timestamp}"
          $zipName = "MedImager_v${version}_preview_${timestamp}.zip"
          $releaseType = "Preview Release"
          $releaseNotes = "这是一个预览版本，可能包含未完全测试的功能。"
        } else {
          $releaseDir = "MedImager_v${version}"
          $zipName = "MedImager_v${version}.zip"
          $releaseType = "Stable Release"
          $releaseNotes = "这是一个稳定的正式版本。"
        }

        New-Item -ItemType Directory -Path $releaseDir
        Copy-Item "dist/MedImager.exe" "$releaseDir/"
        Copy-Item "README.md" "$releaseDir/" -ErrorAction SilentlyContinue
        Copy-Item "README_zh.md" "$releaseDir/" -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" "$releaseDir/" -ErrorAction SilentlyContinue

        @"
        MedImager v$version - $releaseType

        构建时间: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        构建环境: GitHub Actions

        $releaseNotes

        使用方法:
        1. 直接运行 MedImager.exe
        2. 支持拖拽 DICOM 文件或文件夹
        3. 详细使用说明请参考 README.md
        "@ | Out-File -FilePath "$releaseDir/VERSION.txt" -Encoding UTF8

        Compress-Archive -Path "$releaseDir/*" -DestinationPath $zipName

        echo "RELEASE_DIR=$releaseDir" >> $env:GITHUB_ENV
        echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV
        echo "VERSION=$version" >> $env:GITHUB_ENV
        echo "RELEASE_TYPE=$releaseType" >> $env:GITHUB_ENV
        echo "RELEASE_NOTES=$releaseNotes" >> $env:GITHUB_ENV

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MedImager-Windows
        path: ${{ env.ZIP_NAME }}

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        name: MedImager ${{ env.VERSION }} ${{ env.RELEASE_TYPE }}
        body: |
          ## MedImager ${{ env.VERSION }} - ${{ env.RELEASE_TYPE }}

          ### 下载
          - **Windows**: `${{ env.ZIP_NAME }}`

          ### 特性
          - 单文件可执行程序，无需安装
          - 支持多序列 DICOM 文件查看
          - 多视图布局和图像分析工具

          ### 使用方法
          1. 下载并解压 ZIP 文件
          2. 直接运行 `MedImager.exe`
          3. 拖拽 DICOM 文件或文件夹到程序中

          ---
          ${{ env.RELEASE_NOTES }}
        files: ${{ env.ZIP_NAME }}
        prerelease: ${{ github.event.inputs.prerelease || true }}
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
