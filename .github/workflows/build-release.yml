name: Build and Release MedImager

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: true
        type: boolean

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      
    - name: Install dependencies
      run: uv sync --dev
      
    - name: Download UPX
      run: |
        $upxVersion = "4.2.1"
        $upxUrl = "https://github.com/upx/upx/releases/download/v$upxVersion/upx-$upxVersion-win64.zip"
        Invoke-WebRequest -Uri $upxUrl -OutFile "upx.zip"
        Expand-Archive -Path "upx.zip" -DestinationPath "."
        $upxDir = Get-ChildItem -Directory -Name "upx-*"
        echo "UPX_PATH=$upxDir" >> $env:GITHUB_ENV
        
    - name: Build application
      run: |
        uv run pyinstaller `
          --noconfirm `
          --onefile `
          --windowed `
          --name "MedImager" `
          --icon "medimager/icons/favicon.ico" `
          --upx-dir "$env:UPX_PATH" `
          --clean `
          --add-data "medimager;medimager/" `
          "medimager/main.py"
          
    - name: Get project info
      id: project_info
      run: |
        $content = Get-Content "pyproject.toml" -Raw
        $version = ($content | Select-String 'version = "([^"]+)"').Matches[0].Groups[1].Value
        $name = ($content | Select-String 'name = "([^"]+)"').Matches[0].Groups[1].Value
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "name=$name" >> $env:GITHUB_OUTPUT
        
    - name: Create release package
      run: |
        $version = "${{ steps.project_info.outputs.version }}"
        $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
        $releaseDir = "MedImager_v${version}_preview_${timestamp}"
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Path $releaseDir
        
        # å¤åˆ¶æ–‡ä»¶
        Copy-Item "dist/MedImager.exe" "$releaseDir/"
        Copy-Item "README.md" "$releaseDir/" -ErrorAction SilentlyContinue
        Copy-Item "README_zh.md" "$releaseDir/" -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" "$releaseDir/" -ErrorAction SilentlyContinue
        Copy-Item "BUILD.md" "$releaseDir/" -ErrorAction SilentlyContinue
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
        $versionInfo = @"
        MedImager v$version - Preview Release
        
        æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
        æ„å»ºç¯å¢ƒ: GitHub Actions
        
        è¿™æ˜¯ä¸€ä¸ªé¢„è§ˆç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½ã€‚
        å¦‚æœ‰é—®é¢˜è¯·åé¦ˆåˆ°é¡¹ç›®ä»“åº“ã€‚
        
        ä½¿ç”¨æ–¹æ³•:
        1. ç›´æ¥è¿è¡Œ MedImager.exe
        2. æ”¯æŒæ‹–æ‹½ DICOM æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
        3. è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ README.md
        "@
        
        $versionInfo | Out-File -FilePath "$releaseDir/VERSION.txt" -Encoding UTF8
        
        # åˆ›å»º ZIP åŒ…
        $zipName = "MedImager_v${version}_preview_${timestamp}.zip"
        Compress-Archive -Path "$releaseDir/*" -DestinationPath $zipName
        
        echo "RELEASE_DIR=$releaseDir" >> $env:GITHUB_ENV
        echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV
        echo "VERSION=$version" >> $env:GITHUB_ENV
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MedImager-Windows
        path: |
          ${{ env.ZIP_NAME }}
          ${{ env.RELEASE_DIR }}/
          
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version || github.ref_name }}
        name: MedImager ${{ env.VERSION }} Preview
        body: |
          ## MedImager ${{ env.VERSION }} - Preview Release
          
          ğŸš€ **è‡ªåŠ¨æ„å»ºçš„é¢„è§ˆç‰ˆæœ¬**
          
          ### ğŸ“¦ ä¸‹è½½
          - **Windows**: `${{ env.ZIP_NAME }}`
          
          ### âœ¨ ç‰¹æ€§
          - å•æ–‡ä»¶å¯æ‰§è¡Œç¨‹åºï¼Œæ— éœ€å®‰è£…
          - æ”¯æŒå¤šåºåˆ— DICOM æ–‡ä»¶æŸ¥çœ‹
          - å¤šè§†å›¾å¸ƒå±€å’Œå›¾åƒåˆ†æå·¥å…·
          - ç°ä»£åŒ–ç”¨æˆ·ç•Œé¢
          
          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¹¶è§£å‹ ZIP æ–‡ä»¶
          2. ç›´æ¥è¿è¡Œ `MedImager.exe`
          3. æ‹–æ‹½ DICOM æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åˆ°ç¨‹åºä¸­
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - è¿™æ˜¯é¢„è§ˆç‰ˆæœ¬ï¼Œå¯èƒ½åŒ…å«æœªå®Œå…¨æµ‹è¯•çš„åŠŸèƒ½
          - å¦‚é‡åˆ°é—®é¢˜è¯·åœ¨ Issues ä¸­åé¦ˆ
          - è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ README.md
          
          ---
          
          **æ„å»ºä¿¡æ¯**
          - æ„å»ºæ—¶é—´: ${{ steps.project_info.outputs.version }}
          - æ„å»ºç¯å¢ƒ: GitHub Actions
          - Python ç‰ˆæœ¬: 3.11
        files: ${{ env.ZIP_NAME }}
        prerelease: ${{ github.event.inputs.prerelease || true }}
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}