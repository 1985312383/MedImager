# MedImager 软件设计与架构文档

本文档详细阐述了 MedImager 软件的整体设计逻辑、用户界面层级、各组件功能与交互，以及源代码文件与功能模块的对应关系，旨在为后续开发与维护提供清晰的指引。

---

## 1. 软件设计逻辑与UI层级

### 1.1. 核心设计思想

MedImager 采用 **模型-视图-控制器 (MVC)** 的设计模式，严格分离数据处理、用户界面和控制逻辑，以确保代码的高内聚、低耦合，易于维护和扩展。

- **模型 (Core)**: 位于 `medimager/core/` 目录。负责所有的数据管理和业务逻辑，例如 DICOM 解析、图像数据存储、窗宽窗位计算、ROI 定义与统计等。**此层完全独立于UI，禁止导入任何 `medimager/ui/` 中的模块。**
- **视图/控制器 (UI)**: 位于 `medimager/ui/` 目录。负责所有用户界面的展示和用户输入的处理。它可以导入 `core` 来获取和展示数据，并通过信号-槽机制与 `core` 层通信，响应用户操作。
- **工具 (Utils)**: 位于 `medimager/utils/` 目录。提供项目通用的辅助功能，如日志记录、设置管理、主题管理等，不依赖于 `core` 和 `ui`。

### 1.2. 用户界面 (UI) 层级设计

主窗口 `MainWindow` 是所有UI组件的容器，其布局结构如下：

```
MainWindow
└── QSplitter (水平分割器)
    ├── SeriesPanel (左侧序列面板)
    ├── MultiViewerGrid (中央图像网格)
    │   └── ImageViewer (1个或多个图像视图)
    │       └── QGraphicsScene (图像场景)
    │           └── QGraphicsPixmapItem (图像本身)
    └── DicomTagPanel (右侧信息面板)
```

- **主窗口 (`MainWindow`)**: 程序的顶层框架，包含菜单栏、工具栏和状态栏。
- **分割器 (`QSplitter`)**: 允许用户通过拖拽来自由调整左侧、中央、右侧三个区域的宽度。
- **中央图像网格 (`MultiViewerGrid`)**: 是核心工作区，可以根据用户选择（如1x1, 2x2）动态地创建和管理多个独立的 `ImageViewer` 实例。它负责将DICOM序列分配给特定的视图。
- **图像视图 (`ImageViewer`)**: 单个的图像显示单元，负责渲染图像、ROI、测量线等，并将用户的鼠标键盘操作分发给当前激活的**交互工具**。

---

## 2. 组件详解：用法与交互逻辑

### 2.1. 主窗口 (`MainWindow`)

作为"指挥中心"，`MainWindow` 负责初始化所有UI组件，并通过信号-槽机制协调它们之间的通信。


### 2.2. 菜单栏

菜单栏是所有功能的完整集合，定义了各项操作的行为。

-   **文件(&F)**
    -   **打开DICOM文件夹**: 扫描指定文件夹及其子文件夹，加载所有DICOM文件，并按序列（Series）组织。
    -   **打开图像文件**: 加载单个图像文件（如PNG, JPG, NPY等），将其视为一个单切片序列。
    -   **导出**:
        -   **功能**: 提供将当前视图、序列或所有图像导出的能力。
        -   **计划实现**: 导出为 JPEG/PNG 图像、MP4/WMV 视频，或经过处理（如添加了ROI）后，导出为新的DICOM序列。
    -   **匿名化**:
        -   **功能**: 提供工具来修改或移除DICOM文件中的患者姓名、ID等敏感个人信息。
        -   **重要性**: 在科研和教学分享中保护患者隐私的必要功能。
    -   **退出**: 关闭应用程序。
-   **查看(&V)**
    -   **重置视图**: 将当前**活动视图**的缩放、平移状态恢复到初始"适应窗口"的状态。
    -   **显示/隐藏面板**: 通过勾选/取消勾选，控制左侧`序列面板`和右侧`信息面板`的显示与隐藏。
-   **窗位(&W)**
    -   提供多种预设的窗宽/窗位（如腹部、肺窗等）。
    -   **自定义**: 弹出对话框，允许用户手动输入窗宽和窗位值。
    -   *程序逻辑*: 选择任一窗位设置后，`MainWindow`会调用当前**活动视图**关联的`ImageDataModel`的`set_window`方法，模型数据更新后会发出`data_changed`信号，最终触发视图重绘。
-   **布局(&L)**
    -   提供一个网格状的弹出菜单，允许用户选择视图布局（如1x1, 2x2, 2x3等）。
    -   *程序逻辑*: 选择后，`MainWindow`会调用`MultiViewerGrid`的`set_grid_size`方法，清空并重建指定数量的`ImageViewer`实例。

### 2.3. 工具栏

工具栏集中管理了所有与图像交互的核心工具，并提供了更改视图布局的功能。

-   **程序逻辑**: 工具栏上与交互相关的按钮（如默认、测量、ROI）被组织在一个`QActionGroup`中，确保同时只有一个工具能被激活。`MainWindow`根据用户选择，为当前活动视图（`ImageViewer`）设置对应的`BaseTool`子类实例。该工具实例将全权接管后续的鼠标和键盘事件，从而定义用户的交互模式。

-   **交互工具详情**:
    -   **默认工具 (`DefaultTool`)**:
        -   **功能**: 提供最基础、最高频的图像浏览操作，是程序启动后的默认状态。
        -   **操作方式**:
            -   **调整窗位 (WW/WL)**: 按住`鼠标左键`并拖拽。水平移动改变窗宽（对比度），垂直移动改变窗位（亮度）。这是观察不同组织结构的关键。
            -   **平移 (Pan)**: 按住`鼠标中键`并拖拽，用于移动被放大的图像，以查看不同区域。
            -   **缩放 (Zoom)**: 按住`鼠标右键`并拖拽。向上拖拽放大，向下拖拽缩小，以查看图像细节。
            -   **切片浏览**: 滚动`鼠标滚轮`，可以逐一切换3D序列中的不同图像切片。

    -   **测量工具 (`MeasurementTool`)**:
        -   **功能**: 在图像上进行精确的物理距离测量。程序会根据DICOM头中的像素间距信息，自动将像素距离转换为毫米(mm)。
        -   **操作方式**:
            -   **创建**: 激活测量工具后，按住`鼠标左键`从起点拖拽到终点后释放，即可创建一条测量线。测量结果会实时显示在线旁边。
            -   **调整**: 测量线创建后，可以鼠标拖动线的本体来平移，或拖动两端的锚点来改变测量的起点和终点。
            -   **删除**: 选中一条测量线后（通常会高亮显示），按`Delete`键可将其删除。
        -   **计划新增**:
            -   **角度/Cobb角测量**: 用于骨科等场景的专业角度测量。
            -   **标注工具**: 添加箭头和文字，用于在图像上进行标记和说明。

    -   **ROI 工具 (`ROITool`)**:
        -   **功能**: 在图像上绘制不同形状的"感兴趣区域" (Region of Interest)，并自动计算该区域内像素的统计学特征，是进行量化分析的基础。支持`矩形`、`圆形`、`椭圆`等多种形状。
        -   **操作方式**:
            -   **创建**: 激活一种ROI工具（如矩形ROI）后，按住`鼠标左键`拖拽即可绘制出相应形状。在绘制过程中，旁边会有一个信息框实时显示统计数据（最大/最小/均值/标准差等）。
            -   **调整**: ROI创建后，可以拖动ROI的本体进行平移，或拖动其边缘的锚点来改变大小和形状。所有改动都会触发统计值的重新计算。
            -   **信息框**: 显示统计数据的信息框也可以被独立拖动，以放置在不遮挡图像的位置。
            -   **删除**: 选中一个ROI后（通常会高亮显示），按`Delete`键可将其删除。
        -   **计划新增**:
            -   **手绘多边形ROI**: 用于勾勒不规则形状的病灶，比规则图形更灵活、更实用。

-   **布局工具**:
    -   **功能**: 允许用户将主视图区域分割成不同的网格布局（如1x1, 2x2, 2x3等），便于同时加载和对比多个不同的图像序列。
    -   **操作方式**: 点击工具栏上的布局按钮，会弹出一个可视化的网格选择器。用户点击希望的布局（例如2x2），中央的`MultiViewerGrid`会立即清空并重新创建为4个`ImageViewer`实例。

### 2.4. 序列面板 (`SeriesPanel`)

- **用法**:
  - 以可折叠的树状列表形式展示所有已加载的DICOM序列。
  - 父节点是序列信息（如序列描述、实例数），子节点是该序列下的每一个切片。
  - **单击序列**: 将该序列加载到当前**活动视图**中。
  - **单击切片**: 在加载了该序列的视图中，切换到对应的切片。
  - **拖拽序列**: 可以将序列项直接拖拽到中央图像区的任意一个`ImageViewer`中。
- **交互逻辑**:
  - **单击选择**: `SeriesPanel`发出`series_selected`信号 -> `MainWindow`接收信号，调用`MultiViewerGrid.load_series_into_view`方法，将序列加载到**活动视图**。
  - **拖拽加载**: 用户从`SeriesPanel`拖起一个序列项，释放到某个`ImageViewer`上 -> 该`ImageViewer`发出`series_dropped`信号，携带自己的视图索引和序列索引 -> `MainWindow`接收信号，同样调用`MultiViewerGrid.load_series_into_view`加载序列到**指定视图**。
  - **高亮同步**: 当`MultiViewerGrid`中的活动视图改变时，会发出`active_view_changed`信号 -> `MainWindow`接收后，会调用`SeriesPanel`的方法，用特定颜色高亮显示与新活动视图关联的序列项。

### 2.5. 图像面板 (`MultiViewerGrid` 与 `ImageViewer`)

- **用法**:
  - 这是核心交互区域。用户在此区域内查看和分析图像。
  - **视图激活**: 单击任意一个`ImageViewer`，它将成为**活动视图**，表现为边框高亮。所有菜单、工具栏的操作都将优先作用于此视图。
  - **图像交互**: 鼠标和键盘的交互方式由当前选择的工具决定。
- **交互逻辑**:
  - `ImageViewer`接收到底层鼠标事件后，不直接处理，而是调用当前`current_tool`对应的方法（如`mouse_press_event`）。
  - **`DefaultTool` (默认工具)的逻辑**:

    2D Viewer窗口
    |操作 | 功能 |
    |----------|------------|
    |鼠标左键+鼠标移动 |	浏览系列图像[默认设置] |
    |鼠标中键+鼠标移动 |	调整图像窗口（亮度/对比度）[默认设置] |
    |鼠标右键+鼠标移动|	放大/缩小图像[默​​认设置]|
    |后退（第4个）鼠标按钮+鼠标移动|	平移图像[默认设置]|
    |前进（第5个）鼠标键+鼠标移动|	长度测量[默认设置]|
    |Ctrl +鼠标左键单击缩略图|	在新面板中打开系列|
    |Ctrl +鼠标左键+鼠标移动|	调整图像窗口（亮度/对比度）|
    |Shift +鼠标左键+鼠标移动|	平移图片|
    |Ctrl +垂直鼠标滚轮|	放大/缩小图像|
    |垂直鼠标滚轮|	浏览该系列的图像|
    |水平鼠标滚轮|	转到上一个/下一个系列|

- **ROI 交互逻辑**:
  - 当切换到某种ROI工具（如`RectangleROITool`）时：
    - 在`ImageViewer`上按下鼠标左键开始绘制。
    - 绘制过程中，一个**信息框**会实时跟随ROI的右边界移动，并显示统计数据（最大值、最小值、均值、标准差）。
    - 释放鼠标，完成绘制，ROI和信息框被固定在视图上。
    - 切换回`DefaultTool`后，可以拖动ROI本身或其信息框。
    - 拖动ROI的锚点可以改变其大小，信息框内容会同步更新。
    - 选中ROI或信息框后，按`Delete`键可将其删除。

### 2.6. 信息面板 (`DicomTagPanel`)

- **用法**:
  - 以表格形式展示当前**活动视图**中所加载序列的DICOM元数据。
- **交互逻辑**:
  - 当活动视图改变时（`MultiViewerGrid.active_view_changed`信号触发），`MainWindow`会获取新活动视图加载的序列数据模型。
  - 如果模型存在，则提取其DICOM头信息，并调用`DicomTagPanel.update_tags`方法来刷新显示。如果视图为空，则清空面板。

### 2.7. 设置窗口 (`SettingsDialog`)

- **设计 (基于`设置窗口设计文档.md`)**:
  - 左侧为导航，包含"通用"、"工具"等大类。
  - 右侧为详细设置项。
- **功能**:
  - **通用**: 切换界面语言（中/英）、主题（深色/浅色）。
  - **工具**:
    - **ROI设置**: 自定义ROI的边框、填充、锚点等的颜色、大小和透明度。
    - **信息板设置**: 自定义ROI统计信息框的背景、文本、边框颜色和字体大小等。
    - **测量工具**: 自定义测量线的颜色、粗细、锚点和文本样式。
- **交互逻辑**:
  - 所有设置都通过`SettingsManager`进行读写。
  - 修改并保存设置后，`ThemeManager`会重新加载`.toml`主题文件，并应用到整个UI，实现样式的实时更新。

---

## 3. 文件与模块对应关系

```
medimager/
├── main.py                 # 【程序入口】初始化QApplication，加载设置和翻译，创建并显示MainWindow。
│
├── core/                     # 【模型层】处理数据和业务逻辑
│   ├── image_data_model.py   # 定义ImageDataModel，管理单个序列的像素、窗位、ROI等。
│   ├── multi_series_manager.py # 管理多个ImageDataModel实例，负责序列的加载和切换。
│   ├── dicom_parser.py       # 负责从文件解析DICOM数据。
│   ├── roi.py                # 定义各种ROI（圆形、矩形等）的几何形状和行为。
│   └── analysis.py           # 提供ROI统计计算等分析功能。
│
├── ui/                       # 【视图/控制器层】所有UI组件
│   ├── main_window.py        # 【主窗口】实现MainWindow类，组装所有UI，协调交互。
│   ├── multi_viewer_grid.py  # 【图像网格】实现MultiViewerGrid，管理多个ImageViewer。
│   ├── image_viewer.py       # 【图像视图】实现ImageViewer，负责渲染图像和分发输入事件。
│   ├── main_toolbar.py       # 创建主工具栏的函数。
│   │
│   ├── panels/               # 可停靠的面板
│   │   ├── series_panel.py     # 实现SeriesPanel，用于显示序列列表。
│   │   ├── dicom_tag_panel.py  # 实现DicomTagPanel，用于显示DICOM标签。
│   │
│   ├── tools/                # 交互工具
│   │   ├── base_tool.py        # 所有工具的抽象基类。
│   │   ├── default_tool.py     # 实现默认工具的交互逻辑（窗位、缩放、平移等）。
│   │   ├── measurement_tool.py # 实现测量工具的逻辑。
│   │   └── roi_tool.py         # 实现各种ROI绘制工具的逻辑。
│   │
│   └── dialogs/              # 对话框窗口
│       ├── settings_dialog.py  # 实现设置窗口的UI和逻辑。
│       └── custom_wl_dialog.py # 实现自定义窗位输入对话框。
│
└── utils/                    # 【通用工具】
    ├── logger.py             # 配置日志记录。
    ├── settings.py           # SettingsManager，负责配置文件的读写。
    ├── theme_manager.py      # ThemeManager，负责加载和应用.toml主题文件。
    └── i18n.py               # 国际化相关工具。
``` 

---
## 4. 远期功能规划 (Future Development Plan)

### 4.1. 第二阶段：高级可视化 (Advanced Visualization)

此阶段的目标是让 MedImager 从一个"2D查看器"升级为"3D分析工具"，实现真正的三维数据交互。

-   **多平面重建 (MPR - Multi-Planar Reconstruction)**:
    -   **功能**: 根据原始的轴位图像，实时重建出冠状位和矢状位图像。用户可以在三个正交平面上任意浏览，并可进一步实现斜面重建(Oblique)和强度投影(MIP/MinIP/Avg)等功能。
    -   **重要性**: 这是现代DICOM软件的基石，能让医生从任意角度观察病灶，极大提升诊断效率和准确性。

-   **图像融合 (Image Fusion)**:
    -   **功能**: 将两种不同的序列（如PET和CT）以不同颜色叠加在一起显示，用于精确定位高代谢的功能性病灶所在的解剖结构。
    -   **重要性**: 在肿瘤学、神经学等领域是核心诊断工具之一。

### 4.2. 第三阶段：临床工作流整合 (Clinical Integration)

此阶段的目标是将 MedImager 融入真实的临床工作环境。

-   **PACS客户端 (DICOM网络)**:
    -   **功能**: 实现DICOM网络协议（C-FIND, C-MOVE, C-STORE），让 MedImager 可以直接从医院的PACS服务器上搜索、查询和下载图像。
    -   **重要性**: 这是软件能否在医院实际使用的关键，摆脱了必须通过U盘/光盘拷贝数据的限制。

-   **本地数据库/归档**:
    -   **功能**: 建立一个本地数据库，用户可以将重要的病例从文件夹或PACS导入，进行统一管理和快速检索。

### 4.3. 第四阶段：真三维渲染 (High-End 3D)

这是最高阶的功能，专注于提供顶级的视觉效果和交互体验。

-   **三维容积渲染 (3D VRT - Volume Rendering)**:
    -   **功能**: 将整个数据体渲染成一个可以任意旋转、缩放、改变透明度的三维模型，并可通过"虚拟手术刀"剔除不需要的组织。
    -   **重要性**: 为手术规划、医患沟通和教学提供了无与伦比的直观效果。该功能通常需要GPU加速以保证流畅性。

### 计划新增功能:
  - **交叉参考线 (Cross-Reference Lines)**:
    -   **功能**: 当在不同视图中打开相互关联的序列时（如同一个序列的MPR重建视图，或同步的PET和CT），在一个视图中移动鼠标，其他视图会显示对应的位置指示线。
    -   **重要性**: 这是在不同方位图像之间快速定位同一解剖结构的核心功能，极大提升阅片效率。