# MedImager 图像文件加载功能说明

## 支持的图像格式

MedImager 现在支持加载以下类型的图像文件：

### DICOM 文件
- `.dcm` 扩展名的 DICOM 文件
- 无扩展名的 DICOM 文件
- 支持单张 DICOM 文件和 DICOM 序列

### 普通图像文件
- **PNG** (`.png`) - 支持所有 PNG 格式，包括透明通道
- **JPEG** (`.jpg`, `.jpeg`) - 支持标准 JPEG 格式
- **BMP** (`.bmp`) - 支持 Windows 位图格式
- **TIFF** (`.tiff`, `.tif`) - 支持 TIFF 格式
- **GIF** (`.gif`) - 支持 GIF 格式

### 数据文件
- **NumPy 数组** (`.npy`) - 支持 NumPy 保存的数组文件

## 图像处理特性

### 自动格式转换
- **彩色到灰度**: 彩色图像（RGB, RGBA）自动转换为灰度图像，适合医学影像分析
- **透明通道处理**: 自动移除 Alpha 通道
- **调色板图像**: 调色板模式图像自动转换为灰度
- **特殊格式**: 支持 CMYK, YCbCr, LAB, HSV 等格式的自动转换

### 智能窗宽窗位设置
系统会根据图像类型自动设置合适的窗宽窗位：

1. **DICOM 文件**: 优先使用 DICOM 头中的窗宽窗位信息
2. **8位图像** (0-255): 使用标准显示窗口 (W=255, L=127)
3. **其他图像**: 基于像素统计自动计算
   - 窗位 = 图像均值
   - 窗宽 = 4倍标准差（确保覆盖大部分像素值）

### 元数据支持
为普通图像文件创建详细的元数据，包括：
- 文件信息（文件名、格式、尺寸）
- 图像属性（位深度、色彩解释）
- DICOM 兼容信息（用于统一的数据处理）
- 像素间距和切片厚度（默认值）

## 使用方法

### 通过菜单加载
1. 打开 MedImager
2. 选择 `文件` → `打开图像文件`
3. 在文件对话框中选择支持的图像文件
4. 图像将自动加载并显示

### 支持的操作
加载普通图像文件后，您可以：
- 使用鼠标进行缩放、平移
- 调整窗宽窗位
- 使用预设窗位（腹部、脑窗、骨窗等）
- 查看像素值信息
- 使用放大镜功能

## 技术细节

### 像素数据处理
- 所有图像数据内部统一转换为 `float32` 格式
- 保持原始像素值范围和精度
- 支持 8位、16位和浮点图像

### 内存管理
- 使用缓存机制提高显示性能
- 自动清理不需要的数据
- 支持大尺寸图像的高效处理

### 错误处理
- 完善的错误检测和报告
- 自动回退到备用处理方案
- 详细的日志记录便于调试

## 注意事项

1. **依赖库**: 需要安装 Pillow 库来支持普通图像文件加载
2. **颜色转换**: 彩色图像会自动转换为灰度，原始颜色信息会丢失
3. **内存使用**: 大尺寸图像可能占用较多内存
4. **格式限制**: 某些特殊的图像格式可能不被完全支持

## 示例

### 支持的文件类型示例
```
medical_image.dcm          # DICOM 文件
photo.png                  # PNG 图像
scan.jpg                   # JPEG 图像
diagram.bmp                # BMP 图像
analysis.tiff              # TIFF 图像
data.npy                   # NumPy 数组
```

### 自动窗宽窗位示例
- **CT 图像**: 使用 DICOM 中的窗宽窗位
- **X光片**: 基于像素分布自动计算
- **照片**: 标准 8位显示窗口 (W=255, L=127)
- **科学数据**: 基于数据范围自动调整

## 故障排除

### 常见问题

#### 1. 图像加载后不显示
**可能原因**: 图像数据范围超出显示范围
**解决方案**: 
- 检查窗宽窗位设置是否合适
- 尝试使用"自动"窗位预设
- 手动调整窗宽窗位值

#### 2. 彩色图像显示为灰度
**说明**: 这是正常行为，MedImager 会自动将彩色图像转换为灰度以适合医学影像分析
**如需保持彩色**: 未来版本将提供选项

#### 3. 加载大图像时程序卡顿
**解决方案**:
- 确保有足够的内存
- 关闭其他占用内存的程序
- 考虑使用较小的图像进行测试

#### 4. 不支持某些图像格式
**解决方案**:
- 使用图像编辑软件转换为支持的格式
- 确保文件没有损坏
- 检查文件扩展名是否正确

### 技术支持

如果遇到其他问题，请：
1. 检查控制台日志输出
2. 确认 Pillow 库已正确安装
3. 验证图像文件可以在其他程序中正常打开
4. 提供错误信息和图像文件信息以便调试 